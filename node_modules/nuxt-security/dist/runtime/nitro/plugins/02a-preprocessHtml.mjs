import { defineNitroPlugin, getRouteRules } from "#imports";
import * as cheerio from "cheerio/lib/slim";
export default defineNitroPlugin((nitroApp) => {
  nitroApp.hooks.hook("render:html", async (html, { event }) => {
    const { security } = getRouteRules(event);
    if (!security?.sri && (!security?.headers || !security?.headers.contentSecurityPolicy)) {
      return;
    }
    const sections = ["body", "bodyAppend", "bodyPrepend", "head"];
    const cheerios = {};
    for (const section of sections) {
      cheerios[section] = html[section].map((element) => {
        return cheerio.load(element, {
          xml: {
            // Disable `xmlMode` to parse HTML with htmlparser2.
            xmlMode: false,
            decodeEntities: false
          }
        }, false);
      });
    }
    event.context.cheerios = cheerios;
  });
});
